# hw definition file for processing by chibios_hwdef.py
# for Arslan's hardware based on FlyingmoonF427

# MCU class and specific type
MCU STM32F4xx STM32F427xx

# board ID. See Tools/AP_Bootloader/board_types.txt
APJ_BOARD_ID AP_HW_FlyingMoonF427

# crystal frequency
OSCILLATOR_HZ 8000000

# ChibiOS system timer
STM32_ST_USE_TIMER 5

FLASH_SIZE_KB 2048

# space to reserve for bootloader and storage at start of flash
FLASH_RESERVE_START_KB 16

# no I2C buses

# Order of UARTs (and USB) but without USART3 (SBUS)
SERIAL_ORDER OTG1 USART1 EMPTY EMPTY EMPTY EMPTY USART2

# USART1 for GPS
PA9 USART1_TX USART1 NODMA
PA10 USART1_RX USART1 NODMA

# USART2 for telem1
PA2 USART2_TX USART2
PA3 USART2_RX USART2

# serial port for stdout disabled, uses USB instead
STDOUT_SERIAL SD2
STDOUT_BAUDRATE 57600

# USART6 for AUX
#PC6 USART6_TX USART6 NODMA
#PC7 USART6_RX USART6 NODMA

# CAN Busses 2
# PB8 CAN1_RX CAN1
# PB9 CAN1_TX CAN1
# PB5 CAN2_RX CAN2
# PB6 CAN2_TX CAN2

# SPI1 for IMU
PA5  SPI1_SCK SPI1
PA6  SPI1_MISO SPI1
PA7  SPI1_MOSI SPI1

PB1  ICM42688_CS CS

# SPI bus for FRAM, FLASH and BARO
PB3 SPI3_SCK  SPI3
PB4 SPI3_MISO SPI3
PD6 SPI3_MOSI SPI3

PD5 FRAM_CS CS SPEED_VERYLOW
PD4 FLASH_CS CS
PD3 BARO_CS CS

# SPI4 bus for reserve
# PE2 SPI4_SCK SPI4
# PE5 SPI4_MISO SPI4
# PE6 SPI4_MOSI SPI4

# USB Setup
PC0 VBUS INPUT OPENDRAIN
# PA9 VBUS INPUT OPENDRAIN

PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# SWD for flashing
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# SD
PC8 SDIO_D0 SDIO
PC9 SDIO_D1 SDIO
PC10 SDIO_D2 SDIO
PC11 SDIO_D3 SDIO
PC12 SDIO_CK SDIO
PD2 SDIO_CMD SDIO

# SPI device table
SPIDEV icm42688    SPI1 DEVID3  ICM42688_CS  MODE3   10*MHZ    10*MHZ
SPIDEV sdcard      SPI3 DEVID1  FLASH_CS     MODE0   1*MHZ    8*MHZ
SPIDEV ms5611_int  SPI3 DEVID2  BARO_CS      MODE3  20*MHZ    20*MHZ
SPIDEV ramtron     SPI3 DEVID10 FRAM_CS      MODE3   1*MHZ   8*MHZ

define HAL_STORAGE_SIZE 16384

# enable RAMTRON parameter storage
define HAL_WITH_RAMTRON 1

# enable FAT filesystem
define HAL_OS_FATFS_IO 1

# IMU
IMU Invensensev3 SPI:icm42688 ROTATION_ROLL_180_YAW_90
define ALLOW_ARM_NO_IMU

# one barometer
BARO MS5611 SPI:ms5611_int

# also probe external compasses
# define HAL_PROBE_EXTERNAL_I2C_COMPASSES
define ALLOW_ARM_NO_COMPASS

# LED setup is similar to PixRacer
define AP_NOTIFY_GPIO_LED_RGB_ENABLED 1
PB14 LED_RED OUTPUT GPIO(10) #STAT
PB13 LED_GREEN OUTPUT GPIO(11) #ERR
PB12 LED_BLUE OUTPUT GPIO(12) #PWR

define AP_NOTIFY_GPIO_LED_RGB_RED_PIN 10
define AP_NOTIFY_GPIO_LED_RGB_GREEN_PIN 11
define AP_NOTIFY_GPIO_LED_RGB_BLUE_PIN 12

# --- ADC and power sensing setup ---
PC1 VDD_5V_SENS ADC1 SCALE(1)
PC2 BATT_VOLT_SENS ADC1 SCALE(11)
#PC3 BATT_CURR_SENS ADC1 SCALE(17)

define HAL_USE_ADC TRUE
define STM32_ADC_USE_ADC1 TRUE
define HAL_DISABLE_ADC_DRIVER FALSE

# define HAL_STORAGE_DEBUG 1
# define HAL_SPI_DEBUG 1


# UART 2 for programming
# define SERIAL0_BAUD 115200
# define SERIAL0_PROTOCOL 2
